dist: bionic
sudo: required
language: minimal
addons:
  apt:
    sources:
    - sourceline: "ppa:chris-lea/redis-server"
    packages:
    - redis-server
    - redis-tools

branches:
  only:
  - master

services:
- docker
- redis-server

before_install:
- sudo apt --yes --quiet update

# Use PostgreSQL 11
- sudo apt --yes --quiet autoremove --purge postgresql-{,client-,contrib-}{9,10}\*
- sudo apt --yes --quiet install postgresql-11

install:
- docker build --build-arg build_type=dev --tag azafea-tests .

before_script:
# Create the PostgreSQL role and database
- sudo -u postgres createuser azafea
- sudo -u postgres createdb --owner=azafea azafea-tests

# Set the default passwords for PostgreSQL and Redis, as that's what the tests expect
- sudo -u postgres psql --command="ALTER USER azafea WITH PASSWORD 'CHANGE ME!!';"
- redis-cli config set requirepass 'CHANGE ME!!'

matrix:
  include:
  - name: "Integration Tests"
    script:
    - docker run --rm --network=host --entrypoint="" azafea-tests pipenv run test-all
  - name: "Lint and Type Checking"
    script:
    - docker run --rm --network=host --entrypoint="" azafea-tests pipenv run lint
